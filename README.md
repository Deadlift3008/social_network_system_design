# social_network_system_design
https://balun.courses/courses/system_design

<h1>Социальная сеть для путешественников ✈️</h1>

<h3>Функциональные требования:</h3>

- Публикация постов 
- Поддержка прикрепления изображений 
- Поддержка привязки конкретного места к посту (название + адрес) 
- Комментарии под постами 
- Оценки постов 
- Подписки на путешественников
- Просмотр ленты путешественников
- Просмотр страницы места для путешествия
- Поиск мест по названию, адресу с ранжированием по популярности
- Поиск постов по названию, адресу привязанного места

<h3>Нефункциональные требования:</h3>

- Кроссплатформенность: браузер, мобильное приложение
- 10 000 000 DAU
- Поведение:  
   В среднем каждый пользователь:
     - 2 раза в год делает пост, 1 из них с картинкой, оба раза с прикрепленным местом
     - раз в 2 недели оставляет комментарий
     - раз в неделю ставит оценку
     - 2 раза в неделю просматривает ленту с 3мя запросами на подгрузку. По 10 постов за каждую подгрузку
     - раз в месяц делает поиск мест
     - раз в 3 недели делает поиск постов
     - 2 раза в неделю просматривает 5 страниц мест
- Ограничение в 1 000 000 подписок  
- Регионы использования: только СНГ  
- Нет сезонности  
- Ограничение на пост 30КБ без картинок
- Ограничение на изображение для поста 2 мб
- Доступность 99,95%

<h3>Нагрузка и трафик на 1 год:</h3>

- Создание поста 1 RPS, 1 * 15 = 15КБ/С 
  1 год: 15КБ * 86400 * 365 = 473040000КБ ~ 473 ГБ 
- Загрузка картинок 0.5 RPS(если будем делать сами хранение), 1000КБ средняя картинка * 0.5 RPS = 500КБ/С
  1 год: 500КБ * 86400 * 365 ~ 16 ТБ 
- Отправка комментария 8 RPS, 2КБ коммент * 8 RPS = 16КБ/С
  1 год: 16КБ * 86400 * 365 ~ 505 ГБ
- Оставление оценки 16 RPS, 0.001КБ оценка * 16 RPS ~ 0.01КБ/С
  1 год: 0.01КБ * 86400 * 365 ~ 315 МБ
- Просмотр ленты 96 RPS, 10 постов * 15КБ пост * 96RPS ~ 14МБ/С
- Просмотр картинок из постов в ленте 48 RPS, 1000КБ * 48 = 48МБ/С
- Поиск мест 4 RPS, место 15КБ * 4RPS = 60КБ/С
- Поиск постов 6 RPS, 15КБ пост * 10 результатов в выдаче * 6 RPS = 900 КБ/С
- Просмотр страницы места 165 RPS, 15 КБ место * 165 RPS ~ 2.5МБ/С

<p><span style='text-decoration: underline; text-underline-offset: 0.3em'>Одновременные соединения</span> - 10 000 000 DAU * 0.1 = <span style='color: #03fc1c'>1 000 000</span></p>

<h3>Общее описание схемы:</h3>
PostsCommentsScheme - реляционная БД, там храним юзеров, посты и комменты, так как потом удобнее это все вытаскивать когда инфа по посту лежит в одном месте. Прикрепленная картинка лежит в body, картинка запрашивается с клиента. БД пусть будет PgSQL
FeedsScheme - подготовленная лента, куда будут добавлятся новые айдишники постов, реляционности нет, пусть будет mongoDB
RatingsScheme - БД с оценками, средняя оценка по посту оттуда будет попадать в БД PostsCommentsScheme, нужно часто пересчитывать среднее, поэтому используем какой-нить ClickHouse
PlacesScheme - БД со словарем мест, прикрепляемых к постам. Реляционности нет, пусть будет MongoDB
SubscribesScheme - БД для хранения подписок

Для картинок будет blob storage

<h3>Рассчет хранилища на 1 год:</h3>

- Для постов и комментов:
    Disks_for_capacity = 1 ТБ - любой диск подойдет
    traffic_per_second = (15КБ/С + 14 МБ/C + 900 КБ/С + 16 КБ/C) - по трафику любого одного диска достаточно 
    Disks_for_iops = (1 + 96 + 6 + 8)/100. минимум 2 hdd, либо 1 SSD 

    В итоге будет 5 SSD (SATA) по 256 ГБ, так как нужно часто писать
- Для оценок:
    Disks_for_capacity = 315 МБ - любой диск подойдет
    traffic_per_second = 0.01КБ/С - любой диск подойдет
    Disks_for_iops = 16 - любого диска достаточно

    В итоге будет 1 диск SSD(SATA) на 1 ГБ, разбивать не нужно, так как нужно считать аггрегирующей ф-цией
- Для картинок:
    Disks_for_capacity = 16 ТБ любой диск подойдет
    traffic_per_second = 50 МБ/c по трафику любого одного диска достаточно 
    Disks_for_iops = 50 любого диска достаточно

    В итоге будет 1 диск SSD(SATA) на 20 ТБ

<h3>Шардирование и хосты</h3>

- Базу `PostsComments` шардируем по ключу post_id, так будет равномерное распределение, а за постами с комментариями можно будет брать из одного шарда. 
Репликацию делаем master-slave, делаем частично синхронной, частично асинхронной для компромиса между скоростью и надежностью
  Хосты: 5 хостов по 1 диску c 2 репликами на каждом шарде. 5 шардов * 3 ноды = 15 хостов

- Базу `Feeds` шардируем по ключу user_id, так сможем с одного шарда вытащить все посты для пользователя.
Репликацию делаем master-slave, делаем полностью асинхронной для скорости. Потеря данных не так критична должна быть, в теории мы сможем заново вычислить ленту.
  Хосты: Много хостов по 1 диску c 2 репликами на каждом шарде. Пусть будет 10 шардов * 3 = 30 хостов

- Базу `Places` не шардируем, репликацию делаем синхронной master-slave с несколькими репликами, в нее часто писать не должны.
  Хосты: 1 хост, 2 реплики. 1 хост * 3 ноды = 3 хоста всего

- Базу `Ratings` не шардируем, репликация master-slave полусинхронная для компромиса скорости и надежности.
  Хосты: 1 хост, 2 реплики. 1 хост * 3 ноды = 3 хоста всего

- Базу `Subscribes` шардируем по ключу user_id, репликация master-slave полностью(или большей частью) синхронная, подписки кажутся критичными для потери.
  Хосты: Много хостов по диску с 2умя репликами на каждом шарде. Пусть будет 5 шардов * 3 = 15 хостов

